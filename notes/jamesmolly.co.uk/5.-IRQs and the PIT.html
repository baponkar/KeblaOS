<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0112)https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"><!-- is_embed=False -->
<script src="./5.-IRQs and the PIT_files/ca-pub-2761421417962228.js.download"></script><script>
  const observer = new PerformanceObserver((list) => {
    list.getEntries().forEach((entry) => {
      console.log('%o', entry);
    })
  });
  observer.observe({type: "navigation", buffered: true});
</script>
<script src="./5.-IRQs and the PIT_files/athena.js.download" type="text/javascript"></script>
<script type="text/javascript">window.addEventListener('DOMContentLoaded',function(){var v=archive_analytics.values;v.service='wb';v.server_name='wwwb-app221.us.archive.org';v.server_ms=492;archive_analytics.send_pageview({});});</script>
<script type="text/javascript" src="./5.-IRQs and the PIT_files/bundle-playback.js.download" charset="utf-8"></script>
<script type="text/javascript" src="./5.-IRQs and the PIT_files/wombat.js.download" charset="utf-8"></script>
<script>window.RufflePlayer=window.RufflePlayer||{};window.RufflePlayer.config={"autoplay":"on","unmuteOverlay":"hidden"};</script>
<script type="text/javascript" src="./5.-IRQs and the PIT_files/ruffle.js.download"></script>
<script type="text/javascript">
    __wm.init("https://web.archive.org/web");
  __wm.wombat("http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html","20160326061932","https://web.archive.org/","web","/_static/",
	      "1458973172");
</script>
<link rel="stylesheet" type="text/css" href="./5.-IRQs and the PIT_files/banner-styles.css">
<link rel="stylesheet" type="text/css" href="./5.-IRQs and the PIT_files/iconochive.css">
<!-- End Wayback Rewrite JS Include -->
<title>5.-IRQs and the PIT</title><link rel="stylesheet" type="text/css" href="./5.-IRQs and the PIT_files/highlight.css"><link rel="stylesheet" type="text/css" href="./5.-IRQs and the PIT_files/layout.css"></head><body data-new-gr-c-s-check-loaded="14.1086.0" data-gr-ext-installed=""><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script>__wm.rw(0);</script>
<div id="wm-ipp-base" lang="en" style="display: block; direction: ltr;"><template shadowrootmode="closed"><div id="wm-ipp" style="position:fixed;left:0;top:0;right:0;" class="">
<div id="donato" style="position:relative;width:100%;">
  <div id="donato-base">
    <iframe id="donato-if" src="https://archive.org/includes/donate.php?as_page=1&amp;platform=wb&amp;referer=https%3A//web.archive.org/web/20160326061932/http%3A//jamesmolloy.co.uk/tutorial_html/5.-IRQs%2520and%2520the%2520PIT.html" scrolling="no" frameborder="0" style="width:100%; height:100%">
    </iframe>
  </div>
</div><div id="wm-ipp-inside">
  <div id="wm-toolbar" style="position:relative;display:flex;flex-flow:row nowrap;justify-content:space-between;">
    <div id="wm-logo" style="/*width:110px;*/padding-top:12px;">
      <a href="https://web.archive.org/web/" title="Wayback Machine home page"><img src="https://web.archive.org/_static/images/toolbar/wayback-toolbar-logo-200.png" srcset="/_static/images/toolbar/wayback-toolbar-logo-100.png, /_static/images/toolbar/wayback-toolbar-logo-150.png 1.5x, /_static/images/toolbar/wayback-toolbar-logo-200.png 2x" alt="Wayback Machine" style="width:100px" border="0"></a>
    </div>
    <div class="c" style="display:flex;flex-flow:column nowrap;justify-content:space-between;flex:1;">
      <form class="u" style="display:flex;flex-direction:row;flex-wrap:nowrap;" target="_top" method="get" action="https://web.archive.org/web/submit" name="wmtb" id="wmtb"><input type="text" name="url" id="wmtbURL" value="http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html" onfocus="this.focus();this.select();" style="flex:1;" autocomplete="off"><input type="hidden" name="type" value="replay"><input type="hidden" name="date" value="20160326061932"><input type="submit" value="Go">
      </form>
      <div style="display:flex;flex-flow:row nowrap;align-items:flex-end;">
                <div class="s" id="wm-nav-captures" style="flex:1;"><a class="t" href="https://web.archive.org/web/*/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="See a list of every capture for this URL">114 captures</a><div class="r" title="Timespan for captures of this URL">19 Oct 2007 - 11 Dec 2023</div></div>
        <div class="k">
          <a href="https://web.archive.org/web/20220401000000/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html" id="wm-graph-anchor">
            <div id="wm-ipp-sparkline" title="Explore captures for this URL" style="position: relative">
              <canvas id="wm-sparkline-canvas" width="725" height="27" border="0"></canvas>
            <div class="yt" style="display: none; width: 25px; height: 27px; left: 650px;"></div><div class="mt" style="display: none; width: 2px; height: 27px; left: 657px;"></div></div>
          </a>
        </div>
      </div>
    </div>
    <div class="n">
      <table>
        <tbody>
          <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
          <tr class="m">
            <td class="b" nowrap="nowrap"><a href="https://web.archive.org/web/20160224212116/http://www.jamesmolloy.co.uk:80/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="24 Feb 2016"><strong>Feb</strong></a></td>
            <td class="c" id="displayMonthEl" title="You are here: 06:19:32 Mar 26, 2016">Mar</td>
            <td class="f" nowrap="nowrap"><a href="https://web.archive.org/web/20170402142412/http://www.jamesmolloy.co.uk:80/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="02 Apr 2017"><strong>Apr</strong></a></td>
          </tr>
          <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
          <tr class="d">
            <td class="b" nowrap="nowrap"><a href="https://web.archive.org/web/20160311204448/http://www.jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="20:44:48 Mar 11, 2016"><img src="https://web.archive.org/_static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0"></a></td>
            <td class="c" id="displayDayEl" style="width:34px;font-size:22px;white-space:nowrap;" title="You are here: 06:19:32 Mar 26, 2016">26</td>
            <td class="f" nowrap="nowrap"><a href="https://web.archive.org/web/20170402142412/http://www.jamesmolloy.co.uk:80/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="14:24:12 Apr 02, 2017"><img src="https://web.archive.org/_static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"></a></td>
          </tr>
          <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
          <tr class="y">
            <td class="b" nowrap="nowrap"><a href="https://web.archive.org/web/20150326042756/http://www.jamesmolloy.co.uk:80/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="26 Mar 2015"><strong>2015</strong></a></td>
            <td class="c" id="displayYearEl" title="You are here: 06:19:32 Mar 26, 2016">2016</td>
            <td class="f" nowrap="nowrap"><a href="https://web.archive.org/web/20170402142412/http://www.jamesmolloy.co.uk:80/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="02 Apr 2017"><strong>2017</strong></a></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="r" style="display:flex;flex-flow:column nowrap;align-items:flex-end;justify-content:space-between;">
      <div id="wm-btns" style="text-align:right;height:23px;">
                <span class="xxs">
          <div id="wm-save-snapshot-success">success</div>
          <div id="wm-save-snapshot-fail">fail</div>
          <a id="wm-save-snapshot-open" href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html#" title="Share via My Web Archive" style="display: none;">
            <span class="iconochive-web"></span>
          </a>
          <a href="https://archive.org/account/login.php" title="Sign In" id="wm-sign-in" style="display: inline-block;">
            <span class="iconochive-person"></span>
          </a>
          <span id="wm-save-snapshot-in-progress" class="iconochive-web" style="display: none;"></span>
        </span>
                <a class="xxs" href="http://faq.web.archive.org/" title="Get some help using the Wayback Machine" style="top:-6px;"><span class="iconochive-question" style="color:rgb(87,186,244);font-size:160%;"></span></a>
        <a id="wm-tb-close" href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html#close" style="top:-2px;" title="Close the toolbar"><span class="iconochive-remove-circle" style="color:#888888;font-size:240%;"></span></a>
      </div>
      <div id="wm-share" class="xxs">
        <a href="https://web.archive.org/web/20160326061932/http://web.archive.org/screenshot/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html" id="wm-screenshot" title="screenshot" style="visibility: hidden;">
          <span class="wm-icon-screen-shot"></span>
        </a>
        <a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html#" id="wm-video" title="video">
          <span class="iconochive-movies"></span>
        </a>
        <a id="wm-share-facebook" href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html#" data-url="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="Share on Facebook" style="margin-right:5px;" target="_blank"><span class="iconochive-facebook" style="color:#3b5998;font-size:160%;"></span></a>
        <a id="wm-share-twitter" href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html#" data-url="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html" title="Share on Twitter" style="margin-right:5px;" target="_blank"><span class="iconochive-twitter" style="color:#1dcaff;font-size:160%;"></span></a>
      </div>
      <div style="padding-right:2px;text-align:right;white-space:nowrap;">
        <a id="wm-expand" class="wm-btn wm-closed" href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html#expand"><span id="wm-expand-icon" class="iconochive-down-solid"></span> <span class="xxs" style="font-size:80%;">About this capture</span></a>
      </div>
    </div>
  </div>
    <div id="wm-capinfo" style="border-top:1px solid #777;display:none; overflow: hidden">
        <div id="wm-capinfo-notice" source="api"></div>
                <div id="wm-capinfo-collected-by">
    <div style="background-color:#666;color:#fff;font-weight:bold;text-align:center">COLLECTED BY</div>
    <div style="padding:3px;position:relative" id="wm-collected-by-content">
      <div style="display:inline-block;vertical-align:top;width:49%;">
			<span class="c-logo" style="background-image:url(https://archive.org/services/img/web)"></span>
		<div>Collection: <a style="color:#33f;" href="https://archive.org/details/web" target="_new"><span class="wm-title">web</span></a></div>
	      </div>
    </div>
    </div>
    <div id="wm-capinfo-timestamps">
    <div style="background-color:#666;color:#fff;font-weight:bold;text-align:center" title="Timestamps for the elements of this page">TIMESTAMPS</div>
    <div>
      <div id="wm-capresources" style="margin:0 5px 5px 5px;max-height:250px;overflow-y:scroll !important"></div>
      <div id="wm-capresources-loading" style="text-align:left;margin:0 20px 5px 5px;display:none"><img src="https://web.archive.org/_static/images/loading.gif" alt="loading"></div>
    </div>
    </div>
  </div></div></div><link rel="stylesheet" type="text/css" href="./5.-IRQs and the PIT_files/banner-styles.css"><link rel="stylesheet" type="text/css" href="./5.-IRQs and the PIT_files/iconochive.css"><div class="wb-autocomplete-suggestions "></div></template>
</div><div id="wm-ipp-print">The Wayback Machine - https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html</div>
<script type="text/javascript">//<![CDATA[
__wm.bt(725,27,25,2,"web","http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html","20160326061932",1996,"/_static/",["/_static/css/banner-styles.css?v=S1zqJCYt","/_static/css/iconochive.css?v=3PDvdIFv"], false);
  __wm.rw(1);
//]]></script>
<!-- END WAYBACK TOOLBAR INSERT -->
 <div class="header">
<div style="float: right;">
      <script type="text/javascript"><!--
google_ad_client = "pub-2761421417962228";
/* 468x60, created 22/05/08 */
google_ad_slot = "5309073637";
google_ad_width = 468;
google_ad_height = 60;
//-->
      </script>
      <script type="text/javascript" src="./5.-IRQs and the PIT_files/f.txt">
      </script><ins id="aswift_0_expand" style="display:inline-table;border:none;height:60px;margin:0;padding:0;position:relative;visibility:visible;width:468px;background-color:transparent"><ins id="aswift_0_anchor" style="display:block;border:none;height:60px;margin:0;padding:0;position:relative;visibility:visible;width:468px;background-color:transparent"><iframe width="468" height="60" frameborder="0" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;" data-ruffle-polyfilled="" src="./5.-IRQs and the PIT_files/saved_resource.html"></iframe></ins></ins>
    </div>
	www.jamesmolloy.co.uk
	<div class="header_subtitle">
		<a href="https://web.archive.org/web/20160326061932/http://www.jamesmolloy.co.uk/index.html">Home</a> »
	 	JamesM's kernel development tutorials
	</div>
</div>
<div class="main_frame">

<div class="index">
<a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/1.-Environment%20setup.html">1. Environment setup</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/2.-Genesis.html">2. Genesis</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/3.-The%20Screen.html">3. The Screen</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/4.-The%20GDT%20and%20IDT.html">4. The GDT and IDT</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/5.-IRQs%20and%20the%20PIT.html" class="selected">5. IRQs and the PIT</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/6.-Paging.html">6. Paging</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/7.-The%20Heap.html">7. The Heap</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/8.-The%20VFS%20and%20the%20initrd.html">8. The VFS and the initrd</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/9.-Multitasking.html">9. Multitasking</a><br><a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/10.-User%20Mode.html">10. User Mode</a><br></div>
<h1>5. IRQs and the PIT</h1>
<p>In this chapter we're going to be learning about interrupt requests
(IRQs) and the programmable interval timer (PIT).
</p>
<p></p><h2>5.1. Interrupt requests (theory)</h2>
<p>There are several methods for communicating with external devices. Two
of the most useful and popular are polling and interrupting.
</p>
<p><b>Polling</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;Spin in a loop, occasionally checking if the device is ready.<br>
<b>Interrupts</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;Do lots of useful stuff. When the device is ready it will cause a CPU interrupt, causing your handler to be run.<br>
</p>
<p>As can probably be gleaned from my biased descriptions, interrupting is
considered better for many situations. Polling has lots of uses - some CPUs may not have an
interrupt mechanism, or you may have many devices, or maybe you just
need to check so infrequently that it's not worth the hassle of
interrupts. Any rate, interrupts are a very useful method of hardware
communication. They are used by the keyboard when keys are pressed,
and also by the programmable interval timer (PIT).
</p>
<p></p><div class="image_frame"><img src="./5.-IRQs and the PIT_files/pics.png"><br><span class="image_caption">The slave's output is connected to IRQ2 of the master.</span></div>The low-level concepts behind external interrupts are not very
complex. All devices that are interrupt-capable have a line connecting
them to the PIC (programmable interrupt controller). The PIC is the
only device that is directly connected to the CPU's interrupt pin. It
is used as a multiplexer, and has the ability to prioritise between
interrupting devices. It is, essentially, a glorified 8-1
multiplexer. At some point, someone somewhere realised that 8 IRQ
lines just wasn't enough, and they daisy-chained another 8-1 PIC
beside the original. So in all modern PCs, you have 2 PICs, the master
and the slave, serving a total of 15 interruptable devices (one line
is used to signal the slave PIC).
<p></p>
<p>The other clever thing about the PIC is that you can change the
interrupt number it delivers for each IRQ line. This is referred to as
<i>remapping the PIC</i> and is actually extremely useful. When the
computer boots, the default interrupt mappings are:
</p><ul>
<li>IRQ 0..7 - INT 0x8..0xF</li>
<li>IRQ 8..15 - INT 0x70..0x77</li>
</ul>
This causes us somewhat of a problem. The master's IRQ mappings
(0x8-0xF) conflict with the interrupt numbers used by the CPU to
signal exceptions and faults (see last <a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/tutorial_html/4.">chapter</a>). The normal
thing to do is to remap the PICs so that IRQs 0..15 correspond to ISRs
32..47 (31 being the last CPU-used ISR).
<p></p>
<p></p><h2>5.2. Interrupt requests (practical)</h2>
<p>The PICs are communicated with via the I/O bus. Each has a command
port and a data port:
</p><ul>
<li>Master - command: 0x20, data: 0x21</li>
<li>Slave - command: 0xA0, data: 0xA1</li>
</ul>
The code for remapping the PICs is the most difficult and
obfusticated. To remap them, you have to do a full reinitialisation of
them, which is why the code is so long. If you're interested in what's
actually happening, there is a nice description
<a href="https://web.archive.org/web/20160326061932/http://www.osdev.org/wiki/PIC">here</a>.
<p></p>
<p></p><div class="code">
<span class="code_primitive">static</span>&nbsp;<span class="code_primitive">void</span>&nbsp;<span class="code_function">init_idt</span>()<br>
{<br>
&nbsp;&nbsp;...<br>
&nbsp;&nbsp;<span class="code_comment">// Remap the irq table.</span><br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x20,&nbsp;<span class="code_integer">0</span>x11);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>xA0,&nbsp;<span class="code_integer">0</span>x11);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x21,&nbsp;<span class="code_integer">0</span>x20);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>xA1,&nbsp;<span class="code_integer">0</span>x28);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x21,&nbsp;<span class="code_integer">0</span>x04);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>xA1,&nbsp;<span class="code_integer">0</span>x02);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x21,&nbsp;<span class="code_integer">0</span>x01);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>xA1,&nbsp;<span class="code_integer">0</span>x01);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x21,&nbsp;<span class="code_integer">0</span>x0);<br>
&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>xA1,&nbsp;<span class="code_integer">0</span>x0);<br>
&nbsp;&nbsp;...<br>
&nbsp;&nbsp;<span class="code_function">idt_set_gate</span>(<span class="code_integer">32</span>,&nbsp;(<span class="code_primitive">u32int</span>)irq0,&nbsp;<span class="code_integer">0</span>x08,&nbsp;<span class="code_integer">0</span>x8E);<br>
&nbsp;&nbsp;...<br>
&nbsp;&nbsp;<span class="code_function">idt_set_gate</span>(<span class="code_integer">47</span>,&nbsp;(<span class="code_primitive">u32int</span>)irq15,&nbsp;<span class="code_integer">0</span>x08,&nbsp;<span class="code_integer">0</span>x8E);<br>
}
</div>
<p></p>
<p>Notice that now we are also setting IDT gates for numbers 32-47, for
our IRQ handlers. We must, therefore, also add stubs for these in
interrupt.s. Also, though, we need a new macro in interrupt.s - an IRQ
stub will have 2 numbers associated with it - it's IRQ number (0-15)
and it's interrupt number (32-47):
</p>
<p></p><div class="code">
<span class="code_comment">; This macro creates a stub for an IRQ - the first parameter is</span><br>
<span class="code_comment">; the IRQ number, the second is the ISR number it is remapped to.</span><br>
<span class="code_preprocessor">%<span class="code_preprocessor_cmd">macro</span></span>&nbsp;IRQ&nbsp;2<br>
&nbsp;&nbsp;global&nbsp;irq%1<br>
&nbsp;&nbsp;<span class="code_label">irq%1:</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_operator">cli</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_operator">push</span>&nbsp;byte&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_operator">push</span>&nbsp;byte&nbsp;%2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_operator">jmp</span>&nbsp;irq_common_stub<br>
<span class="code_preprocessor">%<span class="code_preprocessor_cmd">endmacro</span></span><br>
&nbsp;<br>
...
</div>
<p></p>
<p></p><div class="code">
IRQ&nbsp;&nbsp;&nbsp;0,&nbsp;&nbsp;&nbsp;&nbsp;32<br>
IRQ&nbsp;&nbsp;&nbsp;1,&nbsp;&nbsp;&nbsp;&nbsp;33<br>
...<br>
IRQ&nbsp;&nbsp;15,&nbsp;&nbsp;&nbsp;&nbsp;47
</div>
<p></p>
<p>We also have a new common stub - <i>irq_common_stub</i>. This is because
IRQs behave subtly differently - before you return from an IRQ
handler, you must inform the PIC that you have finished, so it can
dispatch the next (if there is one waiting). This is known as an EOI
(end of interrupt). There is a slight complication though. If the
master PIC sent the IRQ (number 0-7), we must send an EOI to the
master (obviously). If the <i>slave</i> sent the IRQ (8-15), we must send
an EOI to both the master <i>and</i> the slave (because of the
daisy-chaining of the two).
</p>
<p>First our asm common stub. It is almost identical to
<i>isr_common_stub</i>.
</p>
<p></p><div class="code">
<span class="code_comment">; In isr.c</span><br>
[<span class="code_primitive">EXTERN</span>&nbsp;irq_handler]<br>
<br>
<span class="code_comment">; This is our common IRQ stub. It saves the processor state, sets</span><br>
<span class="code_comment">; up for kernel mode segments, calls the C-level fault handler,</span><br>
<span class="code_comment">; and finally restores the stack frame. </span><br>
<span class="code_label">irq_common_stub:</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">pusha</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_comment">; Pushes edi,esi,ebp,esp,ebx,edx,ecx,eax</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;ax,&nbsp;ds&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_comment">; Lower 16-bits of eax = ds.</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">push</span>&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_comment">; save the data segment descriptor</span><br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;ax,&nbsp;0x10&nbsp;&nbsp;<span class="code_comment">; load the kernel data segment descriptor</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;ds,&nbsp;ax<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;es,&nbsp;ax<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;fs,&nbsp;ax<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;gs,&nbsp;ax<br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">call</span>&nbsp;irq_handler<br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">pop</span>&nbsp;ebx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_comment">; reload the original data segment descriptor</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;ds,&nbsp;bx<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;es,&nbsp;bx<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;fs,&nbsp;bx<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">mov</span>&nbsp;gs,&nbsp;bx<br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">popa</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_comment">; Pops edi,esi,ebp...</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">add</span>&nbsp;esp,&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_comment">; Cleans up the pushed error code and pushed ISR number</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">sti</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_operator">iret</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_comment">; pops 5 things at once: CS, EIP, EFLAGS, SS, and ESP</span>
</div>
<p></p>
<p>Now the C code (goes in isr.c):
</p>
<p></p><div class="code">
<span class="code_comment">// This gets called from our ASM interrupt handler stub.</span><br>
<span class="code_primitive">void</span>&nbsp;<span class="code_function">irq_handler</span>(<span class="code_typedef">registers_t</span>&nbsp;regs)<br>
{<br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// Send an EOI (end of interrupt) signal to the PICs.</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// If this interrupt involved the slave.</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_primitive">if</span>&nbsp;(regs.int_no&nbsp;<span class="code_operator">&gt;</span><span class="code_operator">=</span>&nbsp;<span class="code_integer">40</span>)<br>
&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_comment">// Send reset signal to slave.</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>xA0,&nbsp;<span class="code_integer">0</span>x20);<br>
&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// Send reset signal to master. (As well as slave, if necessary).</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x20,&nbsp;<span class="code_integer">0</span>x20);<br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_primitive">if</span>&nbsp;(interrupt_handlers[regs.int_no]&nbsp;<span class="code_operator">!=</span>&nbsp;<span class="code_integer">0</span>)<br>
&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_typedef">isr_t</span>&nbsp;handler&nbsp;<span class="code_operator">=</span>&nbsp;interrupt_handlers[regs.int_no];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code_function">handler</span>(regs);<br>
&nbsp;&nbsp;&nbsp;}<br>
}
</div>
<p></p>
<p>This is fairly straightforward - if the IRQ was &gt; 7 (interrupt number
&gt; 40), we send a reset signal to the slave. In either case, we send
one to the master also.
</p>
<p>You may also notice that I have added a small custom handler
mechanism, allowing you to register custom interrupt handlers. This
can be very useful as an abstraction technique, and will neaten up our
code nicely.
</p>
<p>Some other declarations are needed:
</p>
<p></p><h3>5.2.1. isr.h</h3>
<p></p><div class="code">
<span class="code_comment">// A few defines to make life a little easier</span><br>
<span class="code_preprocessor">#<span class="code_preprocessor_cmd">define</span>&nbsp;IRQ0&nbsp;32<br>
</span>...<br>
<span class="code_preprocessor">#<span class="code_preprocessor_cmd">define</span>&nbsp;IRQ15&nbsp;47<br>
</span><br>
<span class="code_comment">// Enables registration of callbacks for interrupts or IRQs.</span><br>
<span class="code_comment">// For IRQs, to ease confusion, use the #defines above as the</span><br>
<span class="code_comment">// first parameter.</span><br>
<span class="code_primitive">typedef</span>&nbsp;<span class="code_primitive">void</span>&nbsp;(<span class="code_operator">*</span><span class="code_typedef">isr_t</span>)(<span class="code_typedef">registers_t</span>);<br>
<span class="code_primitive">void</span>&nbsp;<span class="code_function">register_interrupt_handler</span>(<span class="code_primitive">u8int</span>&nbsp;n,&nbsp;<span class="code_typedef">isr_t</span>&nbsp;handler);
</div>
<p></p>
<p></p><h3>5.2.2. isr.c</h3>
<p></p><div class="code">
<span class="code_typedef">isr_t</span>&nbsp;interrupt_handlers[<span class="code_integer">256</span>];<br>
<br>
<span class="code_primitive">void</span>&nbsp;<span class="code_function">register_interrupt_handler</span>(<span class="code_primitive">u8int</span>&nbsp;n,&nbsp;<span class="code_typedef">isr_t</span>&nbsp;handler)<br>
{<br>
&nbsp;&nbsp;interrupt_handlers[n]&nbsp;<span class="code_operator">=</span>&nbsp;handler;<br>
}
</div>
<p></p>
<p>And there we go! We can now handle interrupt requests from external
devices, and dispatch them to custom handlers. Now all we need is some
interrupt requests to handle!
</p>
<p></p><h2>5.3. The PIT (theory)</h2>
<p>The programmable interval timer is a chip connected to IRQ0. It can
interrupt the CPU at a user-defined rate (between 18.2Hz and 1.1931
MHz). The PIT is the primary method used for implementing a system
clock and the only method available for implementing multitasking
(switch processes on interrupt).
</p>
<p>The PIT has an internal clock which oscillates at approximately
1.1931MHz. This clock signal is fed through a <a href="https://web.archive.org/web/20160326061932/http://en.wikipedia.org/wiki/Frequency_divider">frequency divider</a>, to modulate
the final output frequency. It has 3 channels, each with it's own
frequency divider.
</p>
<p></p><ul>
<li>Channel 0 is the most useful. It's output is connected to IRQ0.</li>
<li>Channel 1 is very un-useful and on modern hardware is no longer implemented. It used to control refresh rates for <a href="https://web.archive.org/web/20160326061932/http://en.wikipedia.org/wiki/DRAM">DRAM</a>.</li>
<li>Channel 2 controls the PC speaker.</li>
</ul>
<p></p>
<p>Channel 0 is the only one of use to us at the moment.
</p>
<p>OK, so we want
to set the PIT up so it interrupts us at regular intervals, at
frequency f. I generally set <i>f</i> to be about 100Hz (once every
10 milliseconds), but feel free to set it to whatever you like. To do
this, we send the PIT a 'divisor'. This is the number that it should
divide it's input frequency (1.9131MHz) by. It's dead easy to work
out:
</p>
<p></p><div class="code">
divisor&nbsp;=&nbsp;1193180&nbsp;Hz&nbsp;/&nbsp;frequency&nbsp;(in&nbsp;Hz)
</div>
<p></p>
<p>Also worthy of note is that the PIT has 4 registers in I/O space -
0x40-0x42 are the data ports for channels 0-2 respectively, and 0x43
is the command port.
</p>
<p></p><h2>5.4. The PIT (practical)</h2>
<p>We'll need a few new files. Timer.h has only a declaration in it:
</p>
<p></p><div class="code">
<span class="code_comment">// timer.h -- Defines the interface for all PIT-related functions.</span><br>
<span class="code_comment">//            Written for JamesM's kernel development tutorials.</span><br>
<br>
<span class="code_preprocessor">#<span class="code_preprocessor_cmd">ifndef</span>&nbsp;TIMER_H<br>
</span><span class="code_preprocessor">#<span class="code_preprocessor_cmd">define</span>&nbsp;TIMER_H<br>
</span><br>
<span class="code_preprocessor">#<span class="code_preprocessor_cmd">include</span>&nbsp;"common.h"<br>
</span><br>
<span class="code_primitive">void</span>&nbsp;<span class="code_function">init_timer</span>(<span class="code_primitive">u32int</span>&nbsp;frequency);<br>
<br>
<span class="code_preprocessor">#<span class="code_preprocessor_cmd">endif</span><br>
</span>
</div>
<p></p>
<p>And timer.c doesn't have much in either:
</p>
<p></p><div class="code">
<span class="code_comment">// timer.c -- Initialises the PIT, and handles clock updates.</span><br>
<span class="code_comment">//            Written for JamesM's kernel development tutorials.</span><br>
<br>
<span class="code_preprocessor">#<span class="code_preprocessor_cmd">include</span>&nbsp;"timer.h"<br>
</span><span class="code_preprocessor">#<span class="code_preprocessor_cmd">include</span>&nbsp;"isr.h"<br>
</span><span class="code_preprocessor">#<span class="code_preprocessor_cmd">include</span>&nbsp;"monitor.h"<br>
</span><br>
<span class="code_primitive">u32int</span>&nbsp;tick&nbsp;<span class="code_operator">=</span>&nbsp;<span class="code_integer">0</span>;<br>
<br>
<span class="code_primitive">static</span>&nbsp;<span class="code_primitive">void</span>&nbsp;<span class="code_function">timer_callback</span>(<span class="code_typedef">registers_t</span>&nbsp;regs)<br>
{<br>
&nbsp;&nbsp;&nbsp;tick<span class="code_operator">++</span>;<br>
&nbsp;&nbsp;&nbsp;<span class="code_function">monitor_write</span>(<span class="code_string">"Tick:&nbsp;"</span>);<br>
&nbsp;&nbsp;&nbsp;<span class="code_function">monitor_write_dec</span>(tick);<br>
&nbsp;&nbsp;&nbsp;<span class="code_function">monitor_write</span>(<span class="code_string">"<span class="code_character">\n</span>"</span>);<br>
}<br>
<br>
<span class="code_primitive">void</span>&nbsp;<span class="code_function">init_timer</span>(<span class="code_primitive">u32int</span>&nbsp;frequency)<br>
{<br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// Firstly, register our timer callback.</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_function">register_interrupt_handler</span>(IRQ0,&nbsp;<span class="code_operator">&amp;</span>timer_callback);<br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// The value we send to the PIT is the value to divide it's input clock</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// (1193180 Hz) by, to get our required frequency. Important to note is</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// that the divisor must be small enough to fit into 16-bits.</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_primitive">u32int</span>&nbsp;divisor&nbsp;<span class="code_operator">=</span>&nbsp;<span class="code_integer">1193180</span>&nbsp;<span class="code_operator">/</span>&nbsp;frequency;<br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// Send the command byte.</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x43,&nbsp;<span class="code_integer">0</span>x36);<br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// Divisor has to be sent byte-wise, so split here into upper/lower bytes.</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_primitive">u8int</span>&nbsp;l&nbsp;<span class="code_operator">=</span>&nbsp;(<span class="code_primitive">u8int</span>)(divisor&nbsp;<span class="code_operator">&amp;</span>&nbsp;<span class="code_integer">0</span>xFF);<br>
&nbsp;&nbsp;&nbsp;<span class="code_primitive">u8int</span>&nbsp;h&nbsp;<span class="code_operator">=</span>&nbsp;(<span class="code_primitive">u8int</span>)(&nbsp;(divisor<span class="code_operator">&gt;</span><span class="code_operator">&gt;</span><span class="code_integer">8</span>)&nbsp;<span class="code_operator">&amp;</span>&nbsp;<span class="code_integer">0</span>xFF&nbsp;);<br>
<br>
&nbsp;&nbsp;&nbsp;<span class="code_comment">// Send the frequency divisor.</span><br>
&nbsp;&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x40,&nbsp;l);<br>
&nbsp;&nbsp;&nbsp;<span class="code_function">outb</span>(<span class="code_integer">0</span>x40,&nbsp;h);<br>
}
</div>
<p></p>
<p>OK, lets go through this code. Firstly, we have our <i>init_timer</i>
function. This tells our interrupt mechanism that we want to handle
IRQ0 with the function <i>timer_callback</i>. This will be called
whenever a timer interrupt is recieved. We then calculate the divisor
to be sent to the PIT (see theory above). Then, we send a command byte
to the PIT's command port. This byte (0x36) sets the PIT to repeating
mode (so that when the divisor counter reaches zero it's automatically
refreshed) and tells it we want to set the divisor value.
</p>
<p>We then send the divisor value. Note that it must be sent as two
seperate bytes, not as one 16-bit value.
</p>
<p>When this is done, all we have to do is edit our Makefile, add one
line to main.c
</p>
<p></p><div class="code">
<span class="code_function">init_timer</span>(<span class="code_integer">50</span>);&nbsp;<span class="code_comment">// Initialise timer to 50Hz</span>
</div>
<p></p>
<p></p><div class="image_frame"><img src="./5.-IRQs and the PIT_files/irqs_and_the_pit_bochs.png"><br><span class="image_caption">A clock!</span></div>,compile, and run! You
should get output like that on the right. Note however that bochs does
not accurately emulate the timer chip, so although your code will run
at the correct speed on a real machine, it probably won't in bochs!
<p></p>
<p>Full source code for this tutorial can be found
<a href="https://web.archive.org/web/20160326061932/http://jamesmolloy.co.uk/downloads/irqs_and_the_pit.tar.gz">here</a>.
</p></div>
<div class="footer">Copyright James Molloy 2008 - james&lt;at&gt;jamesmolloy.co.uk</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://web.archive.org/web/20160326061932/https://ssl." : "https://web.archive.org/web/20160326061932/http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./5.-IRQs and the PIT_files/ga.js.download" type="text/javascript"></script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-3513903-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>

<img id="translator-icon" src="chrome-extension://ifbamokmfkcnhbpeokkochdpecopfccd/icons/icon-128.png" style="display: none;"><div id="translator-container" style="display: none;">
<div class="rapid-header">
  <img src="chrome-extension://ifbamokmfkcnhbpeokkochdpecopfccd/icons/logo.svg">
  <img id="rapid-copy" src="chrome-extension://ifbamokmfkcnhbpeokkochdpecopfccd/icons/copy.svg">
</div><div id="rapid-text-wrapper"><span></span></div>

<div class="rapid-footer">
  <span id="rapid-first-language">ENG</span>
  <img id="rapid-arrow-icon" src="chrome-extension://ifbamokmfkcnhbpeokkochdpecopfccd/icons/r-arrow.svg">
  <span id="rapid-second-language">FRN</span>
</div></div></body><grammarly-desktop-integration data-grammarly-shadow-root="true"><template shadowrootmode="open"><style>
      div.grammarly-desktop-integration {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select:none;
        user-select:none;
      }

      div.grammarly-desktop-integration:before {
        content: attr(data-content);
      }
    </style><div aria-label="grammarly-integration" role="group" tabindex="-1" class="grammarly-desktop-integration" data-content="{&quot;mode&quot;:&quot;limited&quot;,&quot;isActive&quot;:false,&quot;isUserDisabled&quot;:false}"></div></template></grammarly-desktop-integration></html>